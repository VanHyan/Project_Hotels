let HttpError,sharp,path,fs,moment,Photo,Hotels;_514‍.x([["default",()=>_514‍.o]]);_514‍.w("http-errors",[["default",["HttpError"],function(v){HttpError=v}]]);_514‍.w("sharp",[["default",["sharp"],function(v){sharp=v}]]);_514‍.w("path",[["default",["path"],function(v){path=v}]]);_514‍.w("fs",[["default",["fs"],function(v){fs=v}]]);_514‍.w("moment",[["default",["moment"],function(v){moment=v}]]);_514‍.w("../models/Photo",[["default",["Photo"],function(v){Photo=v}]]);_514‍.w("../models",[["Hotels",["Hotels"],function(v){Hotels=v}]]);







class PhotosController {
  static upload = async (req, res, next) => {
    try {
      const { file } = req;
      const { user } = req;
      const { hotelId, hotelRoomId } = req.body;
      if (!hotelId) {
        throw new HttpError(422, {
          errors: {
            hotelId: ['there is nor hotel id'],
          },
        });
      }
      const hotel = await Hotels.findOne({ where: { id: hotelId, userId: user }, raw: true });
      if (!hotel) {
        throw new HttpError(422, {
          errors: {
            hotel: ['hotels is not found'],
          },
        });
      }

      if (file) {
        const filePath = moment().format('YYYY-MM');
        const exist = fs.existsSync(path.join(__dirname, `../public/images/${filePath}`));
        if (!exist) {
          fs.mkdirSync(path.join(__dirname, `../public/images/${filePath}`));
        }
        await sharp(file.path)
          .rotate()
          .resize(1000)
          .toFile(path.join(__dirname, `../public/images/${filePath}`, file.filename));

        await Photo.create({
          url: path.join(`/images/${filePath}/`, file.filename),
          hotelId,
          hotelRoomId: hotelRoomId || null,
        });
      } else {
        throw HttpError(403, {
          errors: {
            massage: 'Is not files',
          },
        });
      }
      res.json({
        status: 'ok',
      });
    } catch (e) {
      next(e);
    }
  };

  static deletePhoto = async (req, res, next) => {
    try {
      const { photoId } = req.body;
      if (!photoId) {
        throw new HttpError(422, {
          errors: {
            photoId: ['there is nor photo id'],
          },
        });
      }
      const photo = await Photo.findOne({ where: { id: photoId }, raw: true });
      if (!photo) {
        throw new HttpError(422, {
          errors: {
            photo: ['this photo does not found'],
          },
        });
      }
      const hotel = await Hotels.findOne({ where: { id: photo.hotelId, userId: req.user }, raw: true });
      if (!hotel) {
        throw new HttpError(422, {
          errors: {
            hotel: ['you are not director this hotels'],
          },
        });
      }
      fs.unlinkSync(`./public${photo.url}`);
      await Photo.destroy({ where: { id: photoId } });
      res.json({
        status: 'ok',
      });
    } catch (e) {
      next(e);
    }
  };
}
_514‍.d(PhotosController);
